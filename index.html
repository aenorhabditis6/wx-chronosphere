<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WX åˆ›ä¸–çºªÂ·ç§¯åˆ†ä»ª</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #05070a; 
            --accent-gold: #ffd700; 
            --accent-red: #ff3333; 
            --accent-cyan: #00f3ff; 
            --accent-purple: #bd00ff; 
            --border-color: rgba(255, 215, 0, 0.3);
        }

        body {
            margin: 0; overflow: hidden; background-color: var(--bg-color);
            color: #eeeeee; font-family: 'Noto Serif SC', serif; user-select: none;
        }

        #canvas-container { width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; z-index: 1; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }

        .hud-panel {
            position: absolute; padding: 25px; pointer-events: auto;
            background: linear-gradient(135deg, rgba(0,0,0,0.85) 0%, rgba(0,0,0,0.4) 100%);
            border: 1px solid var(--border-color); backdrop-filter: blur(8px);
        }

        .top-left { 
            top: 20px; left: 20px; 
            border-top: 2px solid var(--accent-gold); border-left: 2px solid var(--accent-gold);
            clip-path: polygon(0 0, 100% 0, 100% 85%, 85% 100%, 0 100%);
        }
        
        .top-right { 
            top: 20px; right: 20px; text-align: right; border: none; background: none;
        }

        .bottom-left {
            bottom: 20px; left: 20px; width: 300px;
            border-bottom: 2px solid var(--accent-cyan);
            font-size: 0.8rem;
        }

        h1 { color: var(--accent-gold); margin: 0; font-size: 1.8rem; letter-spacing: 4px; text-shadow: 0 0 20px rgba(255, 215, 0, 0.6); }
        .subtitle { font-size: 0.8rem; color: var(--accent-cyan); margin-bottom: 10px; font-family: monospace; }

        /* Buttons */
        .btn {
            background: rgba(0, 0, 0, 0.6); border: 1px solid var(--accent-gold); color: var(--accent-gold);
            padding: 8px 16px; cursor: pointer; font-family: 'Noto Serif SC', serif; font-weight: bold;
            transition: all 0.3s ease; margin-top: 5px; font-size: 0.85rem; letter-spacing: 1px;
        }
        .btn:hover { background: var(--accent-gold); color: #000; box-shadow: 0 0 15px var(--accent-gold); }
        .btn-ai { border-color: var(--accent-red); color: var(--accent-red); }
        .btn-ai:hover { background: var(--accent-red); color: #000; box-shadow: 0 0 15px var(--accent-red); }
        .btn-sm { font-size: 0.7rem; padding: 4px 8px; margin-right: 5px; }

        /* Orbit Labels */
        .orbit-label {
            position: absolute; color: rgba(255, 255, 255, 0.6); font-size: 0.9rem; font-weight: 300;
            pointer-events: none; text-align: center; width: 200px; margin-left: -100px;
            text-shadow: 0 0 5px rgba(0, 243, 255, 0.3); letter-spacing: 2px; transition: opacity 0.3s;
        }
        .orbit-date { font-size: 0.7rem; color: var(--accent-gold); display: block; margin-top: 2px; font-family: monospace; }

        /* Tooltip */
        #tooltip {
            position: absolute; background: rgba(10, 15, 25, 0.95); border: 1px solid var(--accent-cyan);
            padding: 15px; display: none; pointer-events: none; max-width: 250px;
            box-shadow: 0 0 30px rgba(0, 243, 255, 0.2); z-index: 1000;
        }
        #tooltip h3 { margin: 0 0 5px 0; color: var(--accent-gold); font-size: 1.1rem; border-bottom: 1px solid #555; }
        .tooltip-hint { font-size: 0.7rem; color: var(--accent-red); margin-top: 8px; font-style: italic; text-align: right; }

        /* Particle Data Panel */
        #particle-panel {
            position: fixed; right: 20px; bottom: 20px; width: 280px;
            background: rgba(5, 8, 12, 0.95); border-right: 2px solid var(--accent-purple);
            padding: 20px; display: none; z-index: 100;
            box-shadow: -10px 10px 30px rgba(0,0,0,0.8);
            pointer-events: auto;
            clip-path: polygon(0 0, 100% 0, 100% 100%, 20px 100%);
        }
        #particle-panel h4 { color: var(--accent-purple); margin: 0 0 10px 0; font-size: 1rem; border-bottom: 1px dashed #444; padding-bottom: 5px; }
        .p-type { font-size: 0.75rem; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; display:block;}
        .p-desc { font-size: 0.85rem; color: #ccc; line-height: 1.5; font-family: monospace; }

        /* Earth Uplink Panel */
        .uplink-content { margin-top: 10px; color: #ccc; line-height: 1.4; height: 120px; overflow-y: auto; font-family: monospace; }
        
        /* Modal */
        #modal, #export-modal {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(15, 18, 24, 0.98); border: 1px solid var(--accent-gold); padding: 30px;
            z-index: 100; display: none; box-shadow: 0 0 80px rgba(0,0,0,0.9); width: 350px;
        }
        #modal input, #modal textarea, #export-code {
            width: 100%; background: rgba(255,255,255,0.1); border: 1px solid #666; color: white;
            padding: 10px; margin-top: 5px; font-family: inherit; box-sizing: border-box;
        }
        .ai-section { border: 1px dashed var(--accent-red); padding: 10px; margin-bottom: 15px; background: rgba(255, 50, 50, 0.1); }
        .modal-btns { display: flex; justify-content: space-between; margin-top: 20px; }
        .loading { opacity: 0.7; cursor: wait; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
    </style>
</head>
<body>

    <div id="canvas-container"></div>

    <div id="ui-layer">
        <div class="hud-panel top-left">
            <h1>ç§¯åˆ†åˆ›ä¸–çºª</h1>
            <div class="subtitle">System: Chrono-Sync // Ver 13.2 [Void Respawn]</div>
            <div class="subtitle" id="current-wx-date"></div>
            
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <button class="btn" onclick="openModal()">+ é“­åˆ»å¾‹æ³•</button>
                <button class="btn btn-ai" id="scan-btn" onclick="deepSpaceScan()">ğŸ‘ è§‚æµ‹å¤©å¹•</button>
            </div>
            
            <div style="border-top: 1px solid #333; padding-top: 10px; margin-top: 10px;">
                <button class="btn btn-sm" onclick="exportData()">ğŸ“¤ å¯¼å‡º</button>
                <button class="btn btn-sm" onclick="clearExpired()" style="color:#ff8888; border-color:#ff8888;">ğŸ§¹ æ¸…ç†æ­»æ˜Ÿ</button>
                <button class="btn btn-sm" onclick="resetData()" style="color:#666; border-color:#666;">ğŸ”„ é‡ç½®</button>
            </div>
        </div>

        <div class="hud-panel top-right">
            <div style="color: var(--accent-gold); font-weight: bold;">å½“å‰è§‚æµ‹åŸŸ</div>
            <div style="font-size: 2.5rem; color: white; text-shadow: 0 0 20px var(--accent-cyan); font-family: monospace;" id="clock-display">00:00</div>
            <div style="color: #aaa; font-size: 0.8rem;" id="real-date-display">YYYY-MM-DD</div>
        </div>

        <!-- Earth Uplink Panel -->
        <div class="hud-panel bottom-left">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span style="color: var(--accent-cyan); font-weight:bold;">ğŸŒ åœ°çƒåŒæ­¥ Â· å·´å°”çš„æ‘©</span>
                <button class="btn btn-sm btn-ai" onclick="uplinkEarth()">ğŸ“¡ æ¥æ”¶è®¯å·</button>
            </div>
            <div class="uplink-content" id="earth-report">
                > æ­£åœ¨æ‰«æç¬¬ 124 å·å¹³è¡Œå®‡å®™...<br>
                > ç­‰å¾…æ‰‹åŠ¨åŒæ­¥ã€‚<br>
                > ...
            </div>
        </div>

        <!-- Particle Info Panel -->
        <div id="particle-panel">
            <span onclick="document.getElementById('particle-panel').style.display='none'" style="float:right; cursor:pointer; color:#666;">[x]</span>
            <h4 id="p-name">ç²’å­åç§°</h4>
            <span class="p-type" id="p-type">ç±»å‹</span>
            <div class="p-desc" id="p-desc">æè¿°æ–‡æœ¬...</div>
        </div>

        <!-- Floating Date Labels -->
        <div id="label-proximal" class="orbit-label">ç¬¬ä¸€æƒæŸ„Â·çº¿<span class="orbit-date" id="date-proximal"></span></div>
        <div id="label-distal" class="orbit-label">ç¬¬äºŒæƒæŸ„Â·é¢<span class="orbit-date" id="date-distal"></span></div>
        <div id="label-outer" class="orbit-label">ç¬¬ä¸‰æƒæŸ„Â·ä½“<span class="orbit-date" id="date-outer"></span></div>

        <div id="tooltip">
            <h3 id="tt-title">Event Name</h3>
            <p id="tt-date">Date</p>
            <p id="tt-desc">Description</p>
            <div id="tt-subtasks" class="subtasks-list"></div>
            <div class="tooltip-hint">ç‚¹å‡»ä»¥æŠ¹é™¤æ­¤å› æœ</div>
        </div>
    </div>

    <!-- Modals -->
    <div id="modal">
        <h3>é“­åˆ»æ–°å¾‹æ³•</h3>
        <div class="ai-section">
            <label style="color: var(--accent-red); font-size: 0.8rem;">â—† ç¥è°•è§£æ (AI)</label>
            <textarea id="ai-input" rows="2" placeholder="ä¾‹å¦‚ï¼šä¸‹å‘¨äº”å»å‚åŠ ç‰©ç†ç³»ç ”è®¨ä¼š..."></textarea>
            <button class="btn btn-ai" id="magic-btn" onclick="magicFill()" style="width: 100%; margin-top: 5px; font-size: 0.8rem;">âœ¨ è§£æ</button>
        </div>
        <label style="font-size: 0.8rem; color: #aaa;">å¾‹æ³•åç§°</label> <input type="text" id="input-title">
        <label style="font-size: 0.8rem; color: #aaa;">ç›®æ ‡æ—¥æœŸ (YYYY-MM-DD)</label> <input type="date" id="input-date">
        <label style="font-size: 0.8rem; color: #aaa;">å¾‹æ³•æè¿°</label> <textarea id="input-desc" rows="2"></textarea>
        <label style="font-size: 0.8rem; color: #aaa;">æ¬¡çº§åˆ†å½¢</label> <input type="text" id="input-subtasks" placeholder="é€—å·åˆ†éš”">
        <div class="modal-btns">
            <button class="btn" onclick="saveEvent()">ç¡®è®¤é“­åˆ»</button>
            <button class="btn" onclick="closeModal()" style="border-color: #888; color: #888;">æ”¾å¼ƒ</button>
        </div>
    </div>

    <div id="export-modal">
        <h3>ä¸–ç•Œçº¿ä»£ç </h3>
        <p style="font-size:0.8rem; color:#aaa;">å¤åˆ¶ä¸‹æ–¹ä»£ç è¦†ç›– GitHub ä¸­çš„ wxEvents æ•°ç»„ã€‚</p>
        <textarea id="export-code" rows="8" readonly></textarea>
        <div class="modal-btns"><button class="btn" onclick="document.getElementById('export-modal').style.display='none'">å…³é—­</button></div>
    </div>

    <script>
        /** === PARTICLE LORE DB === */
        const standardModel = [
            { name: "ä¸Šå¤¸å…‹ (Up Quark)", type: "è´¹ç±³å­Â·ç‰©è´¨åŸºåº•", desc: "æ„æˆå®ä½“çš„æœ€è½»ç –çŸ³ï¼Œç¬¬ä¸‰æƒæŸ„çš„å°˜åŸƒã€‚å®ƒå¸¦æœ‰ +2/3 çš„ç”µè·ï¼Œæ˜¯â€˜å­˜åœ¨â€™çš„æœ€å°æ­£å‘å®šä¹‰ã€‚" },
            { name: "ä¸‹å¤¸å…‹ (Down Quark)", type: "è´¹ç±³å­Â·ç‰©è´¨åŸºåº•", desc: "ä¸ä¸Šå¤¸å…‹çº ç¼ çš„é˜´å½±ï¼Œå¸¦æœ‰ -1/3 çš„ç”µè·ã€‚å®ƒæ˜¯ç¨³æ€ç‰©è´¨çš„é”šç‚¹ï¼Œé˜²æ­¢ä¸‡ç‰©å½’äºçº¯ç²¹çš„å…‰ã€‚" },
            { name: "ç”µå­ (Electron)", type: "è½»å­Â·èƒ½é‡æµ", desc: "è‡ªç”±æ„å¿—çš„ç«èŠ±ï¼Œå›´ç»•åŸå­æ ¸è·³ç€æ¦‚ç‡çš„èˆè¹ˆã€‚å®ƒæ˜¯ç”µç£åŠ›çš„ä½¿è€…ï¼Œä¹Ÿæ˜¯åŒ–å­¦é”®çš„ç¼”é€ è€…ã€‚" },
            { name: "å…‰å­ (Photon)", type: "ç»è‰²å­Â·å› æœ", desc: "ç¬¬ä¸€æƒæŸ„çš„å…·è±¡åŒ–ã€‚å®ƒæ²¡æœ‰è´¨é‡ï¼Œå› æ­¤æ²¡æœ‰æ—¶é—´ã€‚å®ƒæ˜¯çº¯ç²¹çš„â€˜ç°åœ¨â€™ï¼Œè¿æ¥ç€è§‚æµ‹è€…ä¸è¢«è§‚æµ‹è€…ã€‚" },
            { name: "èƒ¶å­ (Gluon)", type: "ç»è‰²å­Â·å¼ºç›¸äº’ä½œç”¨", desc: "å°†å¤¸å…‹å›šç¦åœ¨å¼ºå­ç‰¢ç¬¼ä¸­çš„ç‹±å’ã€‚å®ƒæ˜¯â€˜è‰²å½©â€™çš„ä¼ é€’è€…ï¼Œç»´æŒç€ç‰©è´¨æ ¸å¿ƒçš„ç»å¯¹ç§©åºã€‚" },
            { name: "W/Z ç»è‰²å­", type: "ç»è‰²å­Â·å¼±ç›¸äº’ä½œç”¨", desc: "è¡°å˜ä¸è½¬åŒ–çš„ç‚¼é‡‘æœ¯å£«ã€‚å®ƒä»¬å…è®¸ä¸€ç§å…ƒç´ å˜ä¸ºå¦ä¸€ç§å…ƒç´ ï¼Œæ˜¯æ’æ˜Ÿç‡ƒçƒ§çš„ç§˜å¯†ç«ç§ã€‚" },
            { name: "å¸Œæ ¼æ–¯ç»è‰²å­ (Higgs)", type: "æ ‡é‡ç»è‰²å­Â·è´¨é‡ä¹‹æº", desc: "â€˜ä¸Šå¸ç²’å­â€™ã€‚å®ƒåœ¨çœŸç©ºä¸­æ¿€èµ·æ¶Ÿæ¼ªï¼Œèµ‹äºˆä¸‡ç‰©ä»¥â€˜æƒ¯æ€§â€™çš„æ²‰é‡ä»£ä»·ã€‚æ²¡æœ‰å®ƒï¼Œæˆ‘ä»¬çš†æ˜¯å…‰é€Ÿçš„å¹»å½±ã€‚" },
            { name: "ä¸­å¾®å­ (Neutrino)", type: "è½»å­Â·å¹½çµ", desc: "ç©¿é€ä¸‡ç‰©çš„å¹½çµç²’å­ã€‚å®ƒä»¬ä¸å‚ä¸ç”µç£åŠ›çš„æ¸¸æˆï¼Œå­¤ç‹¬åœ°ç©¿æ¢­äºå®‡å®™çš„ç¼éš™ä¸­ï¼Œè®°å½•ç€æ’æ˜Ÿæ­»äº¡çš„å¹æ¯ã€‚" }
        ];

        /** === CORE LOGIC: TIME & DATA === */
        const formatDate = (date) => date.toISOString().split('T')[0];
        const addDays = (days) => {
            const d = new Date(); d.setDate(d.getDate() + days); return formatDate(d);
        };

        const defaultEvents = [
            { title: "å°ç†Šçš„è¯è¾°", targetDate: addDays(2), desc: "ç†Šæ‰‹å…šå°†åœ¨å¤§å…ä¸¾åŠç››å®´ã€‚", color: "#ff4444", subtasks: ["é¢„å®šèœ‚èœœè›‹ç³•"] },
            { title: "å»ºè®¾å†›æ¼”ä¹ ", targetDate: addDays(14), desc: "é˜¿é˜³å¸¦é¢†çš„æœˆåº¦å†›äº‹æ¼”ç»ƒã€‚", color: "#44ff44", subtasks: ["æ£€ä¿®è£…å¤‡"] },
            { title: "æ»¡æœˆç¥­", targetDate: addDays(28), desc: "å¤©å¹•ä¸­å‡½æ•°æœ€è¿ç»­çš„æ—¶åˆ»ã€‚", color: "#ffff44" },
            { title: "ä»£æ•°å‡ ä½•ç ”è®¨", targetDate: addDays(60), desc: "MJS ä¸»æŒçš„é—­é—¨ä¼šè®®ã€‚", color: "#bd00ff" }
        ];

        let wxEvents = [];

        function initData() {
            const saved = localStorage.getItem('wx_universe_events_v2'); 
            if(saved) {
                wxEvents = JSON.parse(saved);
            } else {
                wxEvents = [...defaultEvents];
            }
            recalcDaysAway(); 
        }

        function recalcDaysAway() {
            const today = new Date();
            today.setHours(0,0,0,0);
            
            wxEvents.forEach(evt => {
                if (!evt.targetDate && evt.daysAway) {
                    const t = new Date(today);
                    t.setDate(t.getDate() + evt.daysAway);
                    evt.targetDate = formatDate(t);
                }
                const target = new Date(evt.targetDate);
                const diffTime = target - today;
                evt.daysAway = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            });
            persistData();
        }

        function persistData() { localStorage.setItem('wx_universe_events_v2', JSON.stringify(wxEvents)); }
        
        function clearExpired() {
            const before = wxEvents.length;
            wxEvents = wxEvents.filter(e => e.daysAway >= 0);
            if(wxEvents.length < before) {
                persistData(); refreshPlanets(); alert(`å·²æ¸…é™¤ ${before - wxEvents.length} ä¸ªè¿‡æœŸå› æœã€‚`);
            } else {
                alert("æ²¡æœ‰æ£€æµ‹åˆ°æ­»æ˜Ÿï¼ˆè¿‡æœŸäº‹ä»¶ï¼‰ã€‚");
            }
        }

        function resetData() {
            if(confirm("ç¡®å®šé‡ç½®ï¼Ÿæ‰€æœ‰æœ¬åœ°æ•°æ®å°†ä¸¢å¤±ã€‚")) {
                localStorage.removeItem('wx_universe_events_v2');
                location.reload();
            }
        }

        function exportData() {
            document.getElementById('export-code').value = `let wxEvents = ${JSON.stringify(wxEvents, null, 4)};`;
            document.getElementById('export-modal').style.display = 'block';
        }

        initData();

        /** === THREE.JS VISUALS === */
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x05070a, 0.015);
        const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
        camera.position.set(0, 50, 80); camera.lookAt(0,0,0);
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        container.appendChild(renderer.domElement);

        // Lights
        scene.add(new THREE.AmbientLight(0x404040, 3));
        const sunLight = new THREE.PointLight(0xffd700, 3, 300); scene.add(sunLight);
        const rimLight = new THREE.DirectionalLight(0x00f3ff, 1); rimLight.position.set(50, 20, 50); scene.add(rimLight);
        scene.add(new THREE.DirectionalLight(0xff3333, 0.5));

        // Objects
        const groupPlanets = new THREE.Group(); scene.add(groupPlanets);
        const groupOrbits = new THREE.Group(); scene.add(groupOrbits);
        const groupEffects = new THREE.Group(); scene.add(groupEffects);

        // Singularity
        const coreMesh = new THREE.Mesh(new THREE.IcosahedronGeometry(3,1), new THREE.MeshStandardMaterial({color:0xffd700, emissive:0xffaa00, wireframe:true}));
        scene.add(coreMesh);
        scene.add(new THREE.Mesh(new THREE.SphereGeometry(2,32,32), new THREE.MeshBasicMaterial({color:0xffffaa})));
        
        // --- 1. Interactive Stars (Higgs Field) ---
        const starsGeo = new THREE.BufferGeometry();
        const starsCount = 2000;
        const starsPos = new Float32Array(starsCount * 3); 
        const starsInit = new Float32Array(starsCount * 3);
        const particleIndices = new Float32Array(starsCount); 

        for(let i=0; i<starsCount; i++) { 
            const idx = i*3;
            const val = (Math.random()-0.5)*500;
            starsPos[idx] = (Math.random()-0.5)*500;
            starsPos[idx+1] = (Math.random()-0.5)*500;
            starsPos[idx+2] = (Math.random()-0.5)*500;
            starsInit[idx] = starsPos[idx];
            starsInit[idx+1] = starsPos[idx+1];
            starsInit[idx+2] = starsPos[idx+2];
            particleIndices[i] = Math.floor(Math.random() * standardModel.length);
        }
        starsGeo.setAttribute('position', new THREE.BufferAttribute(starsPos, 3));
        starsGeo.setAttribute('initialPosition', new THREE.BufferAttribute(starsInit, 3));
        const starsMaterial = new THREE.PointsMaterial({size:0.9, color:0xffffff, transparent:true, opacity:0.8});
        const starField = new THREE.Points(starsGeo, starsMaterial);
        scene.add(starField);

        // --- 2. Deep Void Stars (Restored) ---
        const bgGeo = new THREE.BufferGeometry();
        const bgCount = 1500;
        const bgPos = new Float32Array(bgCount * 3);
        for(let i=0; i<bgCount*3; i++) bgPos[i] = (Math.random()-0.5)*1200;
        bgGeo.setAttribute('position', new THREE.BufferAttribute(bgPos, 3));
        const bgMat = new THREE.PointsMaterial({size:0.7, color:0x555577, transparent:true, opacity:0.4});
        const bgStarField = new THREE.Points(bgGeo, bgMat);
        scene.add(bgStarField);

        // --- 3. Accretion Disk (Restored) ---
        const accGeo = new THREE.BufferGeometry();
        const accCount = 500;
        const accPos = new Float32Array(accCount*3);
        const accVel = []; 
        for(let i=0; i<accCount; i++) {
            let angle = Math.random() * Math.PI * 2;
            let r = 4 + Math.random() * 20; 
            accPos[i*3] = Math.cos(angle)*r;
            accPos[i*3+1] = (Math.random()-0.5)*1; 
            accPos[i*3+2] = Math.sin(angle)*r;
            accVel.push({angle:angle, r:r, speed:0.02+Math.random()*0.03});
        }
        accGeo.setAttribute('position', new THREE.BufferAttribute(accPos, 3));
        const accMat = new THREE.PointsMaterial({color:0xffaa00, size:0.3, transparent:true, opacity:0.6, blending:THREE.AdditiveBlending});
        const accretionSystem = new THREE.Points(accGeo, accMat);
        scene.add(accretionSystem);

        // --- 4. Brownian Motion Green Particles (Restored & Enhanced) ---
        const brownianGeo = new THREE.BufferGeometry();
        const brownianCount = 150; // More particles
        const bPos = new Float32Array(brownianCount * 3);
        const bVel = []; 
        for(let i=0; i<brownianCount; i++){
            bPos[i*3] = (Math.random() - 0.5) * 25; // Slightly wider spread
            bPos[i*3+1] = (Math.random() - 0.5) * 25;
            bPos[i*3+2] = (Math.random() - 0.5) * 25;
            bVel.push(new THREE.Vector3((Math.random()-0.5)*0.1, (Math.random()-0.5)*0.1, (Math.random()-0.5)*0.1));
        }
        brownianGeo.setAttribute('position', new THREE.BufferAttribute(bPos, 3));
        const brownianMat = new THREE.PointsMaterial({ 
            color: 0x00ff44, // Bright Green
            size: 0.7, // Bigger
            transparent: true, 
            opacity: 0.9,
            blending: THREE.AdditiveBlending 
        });
        const brownianParticles = new THREE.Points(brownianGeo, brownianMat);
        scene.add(brownianParticles);

        // Orbit Rings
        const createRing = (r, c, o) => {
            const mesh = new THREE.Mesh(new THREE.RingGeometry(r-0.2, r+0.2, 64), new THREE.MeshBasicMaterial({color:c, transparent:true, opacity:o, side:THREE.DoubleSide, blending:THREE.AdditiveBlending}));
            mesh.rotation.x = Math.PI/2; groupOrbits.add(mesh);
        };
        createRing(20, 0x00f3ff, 0.4); createRing(40, 0x00f3ff, 0.3); createRing(60, 0x00f3ff, 0.2);

        // Planet Logic
        const planetMeshes = [];
        function refreshPlanets() {
            while(groupPlanets.children.length>0) groupPlanets.remove(groupPlanets.children[0]);
            while(groupEffects.children.length>0) groupEffects.remove(groupEffects.children[0]); 
            planetMeshes.length = 0;

            wxEvents.forEach((evt, i) => {
                let r, color = evt.color || "#ffffff";
                let isDead = false;

                if (evt.daysAway < 0) {
                    r = 6 + Math.random() * 2; 
                    color = "#555555";
                    isDead = true;
                } else {
                    r = 10 + (evt.daysAway * 0.8);
                    if (r > 70) r = 70;
                }

                const angle = (i / wxEvents.length) * Math.PI * 2;
                const speed = isDead ? 0.005 : 0.5 / Math.pow(r, 1.5); 

                const geo = new THREE.SphereGeometry(isDead ? 0.4 : 0.8, 16, 16);
                const mat = new THREE.MeshStandardMaterial({ 
                    color: color, roughness: 0.2, emissive: color, emissiveIntensity: isDead ? 0 : 0.6 
                });
                const planet = new THREE.Mesh(geo, mat);
                planet.position.set(Math.cos(angle)*r, 0, Math.sin(angle)*r);
                
                if (!isDead) {
                    const tGeo = new THREE.BufferGeometry();
                    const tPos = new Float32Array(50*3);
                    tGeo.setAttribute('position', new THREE.BufferAttribute(tPos, 3));
                    const trail = new THREE.Line(tGeo, new THREE.LineBasicMaterial({color:color, transparent:true, opacity:0.3}));
                    groupEffects.add(trail);
                    planet.userData.trail = trail;
                    planet.userData.trailPositions = tPos;
                }

                planet.userData = { ...evt, radius: r, angle: angle, speed: speed, moons: [], originalRef: evt, isDead: isDead };
                
                const lGeo = new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(0,0,0), new THREE.Vector3(0, isDead? -1 : -5, 0)]);
                planet.add(new THREE.Line(lGeo, new THREE.LineBasicMaterial({color:color, transparent:true, opacity:0.3})));

                if (!isDead && evt.subtasks) {
                    evt.subtasks.slice(0,3).forEach((s, idx) => {
                        const mMesh = new THREE.Mesh(new THREE.TetrahedronGeometry(0.25), new THREE.MeshStandardMaterial({color:color}));
                        const dist = 1.5 + idx*0.7;
                        mMesh.userData = { dist: dist, angle: Math.random()*6, speed: 0.05 + idx*0.02 };
                        planet.add(mMesh);
                        planet.userData.moons.push(mMesh);
                    });
                }

                groupPlanets.add(planet);
                planetMeshes.push(planet);
            });
        }
        refreshPlanets();

        /** INTERACTION */
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        let mouseX=0, mouseY=0;
        let isDragging=false, prevMouse={x:0,y:0}, theta=0, phi=60, zoom=80;

        document.addEventListener('mousedown', e => { isDragging=true; prevMouse={x:e.offsetX, y:e.offsetY}; });
        document.addEventListener('mouseup', () => isDragging=false);
        document.addEventListener('wheel', e => { zoom += e.deltaY*0.05; zoom=Math.max(20, Math.min(150, zoom)); });
        
        document.addEventListener('mousemove', e => {
            mouseX = e.clientX; mouseY = e.clientY;
            mouse.x = (e.clientX/window.innerWidth)*2-1; mouse.y = -(e.clientY/window.innerHeight)*2+1;
            if(isDragging) {
                theta -= (e.offsetX - prevMouse.x)*0.005;
                phi -= (e.offsetY - prevMouse.y)*0.2;
                phi = Math.max(10, Math.min(100, phi));
                prevMouse = {x:e.offsetX, y:e.offsetY};
            }
        });

        renderer.domElement.addEventListener('click', e => {
            if(Math.hypot(e.offsetX-prevMouse.x, e.offsetY-prevMouse.y) > 5) return;
            raycaster.setFromCamera(mouse, camera);
            
            // 1. Check Planets
            const hits = raycaster.intersectObjects(planetMeshes);
            if(hits.length>0) {
                const data = hits[0].object.userData;
                const msg = data.isDead ? "è¿™æ˜¯ä¸€é¢—æ­»æ˜Ÿï¼ˆè¿‡æœŸäº‹ä»¶ï¼‰ã€‚\nè¦å½»åº•åˆ†è§£å®ƒå—ï¼Ÿ" : `ã€å¤©é“å®¡åˆ¤ã€‘\næŠ¹é™¤å› æœï¼š${data.title}ï¼Ÿ`;
                if(confirm(msg)) {
                    const idx = wxEvents.indexOf(data.originalRef);
                    if(idx>-1) {
                        if(data.trail) groupEffects.remove(data.trail);
                        wxEvents.splice(idx, 1); persistData(); refreshPlanets();
                    }
                }
                return; // Prioritize planets
            }

            // 2. Check Background Stars
            raycaster.params.Points.threshold = 2; 
            const starHits = raycaster.intersectObject(starField);
            
            if(starHits.length > 0) {
                const index = starHits[0].index;
                const pID = particleIndices[index];
                const info = standardModel[pID];
                const panel = document.getElementById('particle-panel');
                panel.style.display = 'block';
                document.getElementById('p-name').innerText = info.name;
                document.getElementById('p-type').innerText = info.type;
                document.getElementById('p-desc').innerText = info.desc;
            }
        });

        /** ANIMATION */
        function animate() {
            requestAnimationFrame(animate);
            
            const rPhi = THREE.MathUtils.degToRad(phi);
            camera.position.set(zoom*Math.sin(rPhi)*Math.sin(theta), zoom*Math.cos(rPhi), zoom*Math.sin(rPhi)*Math.cos(theta));
            camera.lookAt(0,0,0);

            // Animate Deep Void Background
            bgStarField.rotation.y += 0.0001;

            // Animate Accretion Disk
            const accArr = accretionSystem.geometry.attributes.position.array;
            for(let i=0; i<accCount; i++) {
                const v = accVel[i];
                v.angle += v.speed;
                v.r -= 0.05; 
                if(v.r < 3) v.r = 24; 
                accArr[i*3] = Math.cos(v.angle)*v.r;
                accArr[i*3+2] = Math.sin(v.angle)*v.r;
            }
            accretionSystem.geometry.attributes.position.needsUpdate = true;

            // Animate Brownian (Green Particles)
            const bPosAttr = brownianGeo.attributes.position;
            for(let i=0; i<brownianCount; i++){
                let x = bPosAttr.getX(i) + bVel[i].x;
                let y = bPosAttr.getY(i) + bVel[i].y;
                let z = bPosAttr.getZ(i) + bVel[i].z;
                if(Math.abs(x) > 25) bVel[i].x *= -1;
                if(Math.abs(y) > 25) bVel[i].y *= -1;
                if(Math.abs(z) > 25) bVel[i].z *= -1;
                bPosAttr.setXYZ(i, x, y, z);
            }
            bPosAttr.needsUpdate = true;

            // Higgs Field (RESTORED ATTRACTION & RESPAWN)
            raycaster.setFromCamera(mouse, camera);
            const posAttr = starsGeo.attributes.position;
            const initAttr = starsGeo.attributes.initialPosition;
            const ray = raycaster.ray;
            const temp = new THREE.Vector3(), target = new THREE.Vector3();
            // Reuse vector for camera distance check
            const starPos = new THREE.Vector3(); 

            for(let i=0; i<starsCount; i++) {
                // --- Camera Proximity Check (Annihilation) ---
                starPos.set(posAttr.getX(i), posAttr.getY(i), posAttr.getZ(i));
                if(starPos.distanceToSquared(camera.position) < 25) { // ~5 units distance
                    const nX = (Math.random()-0.5)*600; 
                    const nY = (Math.random()-0.5)*600;
                    const nZ = (Math.random()-0.5)*600;
                    initAttr.setXYZ(i, nX, nY, nZ); 
                    posAttr.setXYZ(i, nX, nY, nZ);  
                    continue; 
                }

                temp.set(initAttr.getX(i), initAttr.getY(i), initAttr.getZ(i));
                const distSq = ray.distanceSqToPoint(temp);

                if(distSq < 1500) {
                    ray.closestPointToPoint(temp, target);
                    const tx = posAttr.getX(i) + (target.x - posAttr.getX(i)) * 0.1;
                    const ty = posAttr.getY(i) + (target.y - posAttr.getY(i)) * 0.1;
                    const tz = posAttr.getZ(i) + (target.z - posAttr.getZ(i)) * 0.1;
                    posAttr.setXYZ(i, tx, ty, tz);
                } else {
                    const tx = posAttr.getX(i) + (temp.x - posAttr.getX(i)) * 0.05;
                    const ty = posAttr.getY(i) + (temp.y - posAttr.getY(i)) * 0.05;
                    const tz = posAttr.getZ(i) + (temp.z - posAttr.getZ(i)) * 0.05;
                    posAttr.setXYZ(i, tx, ty, tz);
                }
            }
            posAttr.needsUpdate = true;

            coreMesh.rotation.y += 0.01; coreMesh.rotation.z += 0.005;

            // CHECK HOVER FOR FREEZE LOGIC
            raycaster.params.Points.threshold = 1; 
            const planetHits = raycaster.intersectObjects(planetMeshes);
            const tooltip = document.getElementById('tooltip');
            let frozenPlanet = null;

            if(planetHits.length > 0) {
                const hit = planetHits[0].object;
                const data = hit.userData;
                frozenPlanet = hit; // SET FROZEN PLANET
                
                tooltip.style.display = 'block';
                tooltip.style.left = (mouseX+20)+'px'; tooltip.style.top = (mouseY+20)+'px';
                document.getElementById('tt-title').innerText = data.title;
                document.getElementById('tt-date').innerText = data.isDead ? "çŠ¶æ€: [å·²åç¼©]" : `ç›®æ ‡æ—¥æœŸ: ${data.targetDate} (å‰©ä½™ ${data.daysAway} å¤©)`;
                document.getElementById('tt-desc').innerText = data.desc;
                document.getElementById('tt-subtasks').style.display = data.subtasks ? 'block' : 'none';
                if(data.subtasks) document.getElementById('tt-subtasks').innerHTML = '<strong>åˆ†å½¢ä»»åŠ¡:</strong><br>'+data.subtasks.map(s=>`â€¢ ${s}`).join('<br>');
                document.body.style.cursor = 'pointer';
            } else {
                // Check star hover only if not hovering planet
                raycaster.params.Points.threshold = 2;
                const starHits = raycaster.intersectObject(starField);
                if(starHits.length > 0) {
                    document.body.style.cursor = 'help'; 
                    tooltip.style.display = 'none';
                } else {
                    tooltip.style.display = 'none';
                    document.body.style.cursor = 'default';
                }
            }

            planetMeshes.forEach(p => {
                if(p === frozenPlanet) return; // FREEZE LOGIC APPLIED HERE

                const d = p.userData;
                d.angle += d.speed;
                const x = Math.cos(d.angle)*d.radius, z = Math.sin(d.angle)*d.radius;
                p.position.set(x, 0, z);
                
                if(d.trail) {
                    const arr = d.trailPositions;
                    for(let i=arr.length-1; i>=3; i--) arr[i] = arr[i-3];
                    arr[0]=x; arr[1]=0; arr[2]=z;
                    d.trail.geometry.attributes.position.needsUpdate = true;
                }
                
                d.moons.forEach(m => {
                    m.userData.angle += m.userData.speed;
                    m.position.set(Math.cos(m.userData.angle)*m.userData.dist, 0, Math.sin(m.userData.angle)*m.userData.dist);
                });
            });

            updateLabels();
            renderer.render(scene, camera);
        }
        animate();

        function updateLabels() {
            const update = (id, r, offsetDays) => {
                const vec = new THREE.Vector3(r, 0, 0).project(camera);
                const el = document.getElementById(id);
                const dateEl = document.getElementById(id.replace('label-', 'date-'));
                if(Math.abs(vec.x)>1 || Math.abs(vec.y)>1 || vec.z>1) { el.style.opacity=0; return; }
                el.style.opacity=1;
                el.style.transform = `translate(-50%,-50%) translate(${(vec.x*0.5+0.5)*window.innerWidth}px, ${(-vec.y*0.5+0.5)*window.innerHeight}px)`;
                
                const d = new Date(); d.setDate(d.getDate() + offsetDays);
                const mon = (d.getMonth()+1).toString().padStart(2,'0');
                const day = d.getDate().toString().padStart(2,'0');
                dateEl.innerText = ` [${mon}-${day}]`;
            };
            update('label-proximal', 20, 12); 
            update('label-distal', 40, 37);   
            update('label-outer', 60, 62);    
        }

        setInterval(() => {
            const now = new Date();
            document.getElementById('clock-display').innerText = now.getHours().toString().padStart(2,'0') + ":" + now.getMinutes().toString().padStart(2,'0');
            document.getElementById('real-date-display').innerText = now.toISOString().split('T')[0];
        }, 1000);

        /** === EARTH UPLINK (AI) === */
        let apiKey = localStorage.getItem("wx_gemini_key") || "";

        async function callGemini(prompt) {
            if(!apiKey) {
                const k = prompt("è¯·è¾“å…¥ Gemini API Key ä»¥è¿æ¥åœ°çƒè®¯å·ï¼š");
                if(k) { apiKey=k; localStorage.setItem("wx_gemini_key", k); }
                else return null;
            }
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({contents:[{parts:[{text:prompt}]}]})
                });
                const d = await res.json();
                return d.candidates?.[0]?.content?.parts?.[0]?.text;
            } catch(e) { console.error(e); return null; }
        }

        async function uplinkEarth() {
            const report = document.getElementById('earth-report');
            report.innerHTML = "> æ­£åœ¨æ ¡å‡†é‡å­ä¿¡é“...<br>> è·å–å·´å°”çš„æ‘©è§‚æµ‹æ•°æ®...";
            
            const prompt = `
            ä½ æ˜¯ä¸€ä¸ªç§‘å¹»é£æ ¼çš„è§‚æµ‹AIï¼Œä»£å·â€œç§¯åˆ†ä»ªâ€ã€‚
            è¯·ç”Ÿæˆä¸€ä»½å…³äºâ€œåœ°çƒåŒºåŸŸ-å·´å°”çš„æ‘© (Baltimore, USA)â€çš„å®æ—¶ç¯å¢ƒæŠ¥å‘Šã€‚
            
            1. ä»Šå¤©çš„æ—¥æœŸæ˜¯ï¼š${new Date().toLocaleDateString()}ã€‚
            2. è¯·åŸºäºä½ æ‹¥æœ‰çš„å¸¸è¯†çŸ¥è¯†ï¼Œæ¨æµ‹å·´å°”çš„æ‘©ä»Šå¤©è¿™ä¸ªå­£èŠ‚/æœˆä»½é€šå¸¸çš„æ˜Ÿç©ºç‰¹å¾ï¼ˆæœ‰ä»€ä¹ˆæ˜Ÿåº§å¯è§ï¼‰å’Œå¤§è‡´æ°”å€™ï¼ˆæ— éœ€è”ç½‘ï¼Œè¿›è¡Œåˆç†æ¨æ¼”ï¼‰ã€‚
            3. è¯·ç”¨â€œä¸­äºŒâ€çš„ã€Šç§¯åˆ†åˆ›ä¸–çºªã€‹ä¸–ç•Œè§‚å£å»ï¼ˆæ¯”å¦‚ï¼šå¤§æ°”ä¸­çš„æ°´å…ƒç´ æµ“åº¦ï¼Œæ’æ˜Ÿå…‰åº¦ç­‰ï¼‰ã€‚
            4. å­—æ•°æ§åˆ¶åœ¨ 100 å­—ä»¥å†…ï¼Œåˆ†æ¡åˆ—å‡ºã€‚
            `;

            const text = await callGemini(prompt);
            if(text) report.innerHTML = text.replace(/\n/g, '<br>');
            else report.innerHTML = "> è®¯å·è¿æ¥å¤±è´¥ã€‚";
        }

        async function deepSpaceScan() {
            const b = document.getElementById('scan-btn'); b.innerText = "æ‰«æä¸­..."; b.classList.add('loading');
            const res = await callGemini(`ç”Ÿæˆ3ä¸ªç¬¦åˆã€Šç§¯åˆ†åˆ›ä¸–çºªã€‹ä¸–ç•Œè§‚çš„æœªæ¥æ—¥ç¨‹JSONï¼š[{"title":"", "targetDate":"YYYY-MM-DD", "desc":"", "color":"", "subtasks":[]}]ã€‚ä»Šå¤©æ˜¯${new Date().toISOString().split('T')[0]}ï¼Œè¯·å¾€åæ¨ç®—æ—¥æœŸã€‚`);
            if(res) {
                try {
                    const evts = JSON.parse(res.replace(/```json|```/g,'').trim());
                    evts.forEach(e => { 
                        if(e.daysAway && !e.targetDate) e.targetDate = addDays(e.daysAway);
                        wxEvents.push(e); 
                    });
                    recalcDaysAway(); refreshPlanets(); alert(`æ•è· ${evts.length} ä¸ªæ–°å˜é‡ã€‚`);
                } catch(e){console.error(e);}
            }
            b.innerText = "ğŸ‘ è§‚æµ‹å¤©å¹•"; b.classList.remove('loading');
        }

        async function magicFill() {
            const txt = document.getElementById('ai-input').value;
            const b = document.getElementById('magic-btn'); b.innerText="...";
            const res = await callGemini(`Extract event JSON from "${txt}". Today is ${new Date().toISOString().split('T')[0]}. Return {"title":"", "targetDate":"YYYY-MM-DD", "desc":"", "subtasks":[]}`);
            if(res) {
                try {
                    const d = JSON.parse(res.replace(/```json|```/g,'').trim());
                    document.getElementById('input-title').value = d.title;
                    document.getElementById('input-date').value = d.targetDate;
                    document.getElementById('input-desc').value = d.desc;
                    if(d.subtasks) document.getElementById('input-subtasks').value = d.subtasks.join(',');
                } catch(e){}
            }
            b.innerText="âœ¨ è§£æ";
        }

        const modal = document.getElementById('modal');
        function openModal() { modal.style.display='block'; document.getElementById('input-date').value = addDays(1); }
        function closeModal() { modal.style.display='none'; }
        function saveEvent() {
            const t = document.getElementById('input-title').value;
            const d = document.getElementById('input-date').value;
            if(t && d) {
                const sub = document.getElementById('input-subtasks').value.split(',').filter(s=>s);
                wxEvents.push({ title:t, targetDate:d, desc:document.getElementById('input-desc').value, color:"#00f3ff", subtasks:sub });
                recalcDaysAway(); refreshPlanets(); closeModal();
            }
        }
    </script>
</body>
</html>
